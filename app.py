import streamlit as st
import pandas as pd
import numpy as np
import joblib

st.set_page_config(page_title="ูุธุงู ุณูุงุฏ - ุฃูุงูุฉ ุงูุนุงุตูุฉ ุงูููุฏุณุฉ", layout="centered")

st.image("sanad_logo.png", width=160)
st.markdown("<h2 style='text-align: right; color: #135846;'>ูุธุงู ุณูุงุฏ ูุชุตููู ุฃููููุฉ ุงูุจูุงุบุงุช</h2>", unsafe_allow_html=True)
st.markdown("<p style='text-align: right;'>ููุตุฉ ุฐููุฉ ุฏุงุฎููุฉ ููุฏููุฉ ูู ุฃูุงูุฉ ุงูุนุงุตูุฉ ุงูููุฏุณุฉ ูุชุญููู ูุชุตููู ุฃููููุฉ ุงูุจูุงุบุงุช ุจูุงุกู ุนูู ููุน ุงูุฎุฏูุฉ ูุนุฏุฏ ุงูุณูุงู ููููุน ุงูุจูุงุบ.</p>", unsafe_allow_html=True)
st.markdown("---")

uploaded_file = st.file_uploader("ุชุญููู ููู ุงูุจูุงุบุงุช (ุจุตูุบุฉ Excel)", type=["xlsx"])

if uploaded_file is not None:
    df = pd.read_excel(uploaded_file)

    model = joblib.load("rf_model_only.pkl")
    df = df.rename(columns={'ุนุฏุฏ ุชูุฑุงุฑ ุงูุจูุงุบ': 'ุนุฏุฏ ุงูุจูุงุบุงุช'})

    danger_map = {
        'ุชุบููู ุงููุจุงูู': 1,
        'ุชุณููุฑ ุงููุจุงูู': 2,
        'ุงูุญูุงุฌุฒ ุงูุฎุฑุณุงููุฉ': 3,
        'ุณูุงุฑุงุช ุชุงููุฉ': 4,
        'ูุฎููุงุช ุงูุจูุงุก': 5,
        'ุฃุนูุฏุฉ ุฅูุงุฑุฉ': 6
    }
    df['ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ'] = df['ููุน ุงูุฎุฏูุฉ'].map(danger_map)

    group1 = ['ุญู ุงูุฑูุงู','ุญู ุงูุดุฑุงุฆุน','ุญู ุงูููุงุฑูุฉ','ุญู ุงูุนูุงูู','ุญู ุงููุนููุฉ','ุญู ุงูุชูุนูู','ุญู ุงููุฌูุฉ','ุญู ุงููุฌุฑุฉ']
    group2 = ['ุดุงุฑุน ุงูุนุฒูุฒูุฉ','ุดุงุฑุน ุงูุญุฌ','ููุทูุฉ ุงูุญุฑู','ุดุงุฑุน ุฃุฌูุงุฏ']
    group3 = ['ุจุญุฑุฉ ุงููุฌุงูุฏูู','ุดุงุฑุน ุซุจูุฑ','ุญู ุฌุจู ุงูููุฑ','ุญู ุงูุณูุงู','ุญู ุงูุบุฒุงูู',
              'ุญู ุงูุดูููุฉ','ุญู ุญุฏุงุก','ุดุงุฑุน ุงูููุซ','ุญู ุงูุฎูุณุงุก','ุดุงุฑุน ุนูุฑ ุจู ุงูุฎุทุงุจ',
              'ุดุงุฑุน ุจุญุฑุฉ ุงูุนุงู','ุดุงุฑุน ุงูููุฑูุฉ']

    def classify_site(location):
        if location in group1:
            return 0
        elif location in group2:
            return 2
        elif location in group3:
            return 1
        else:
            return 3

    df['ุตูุฉ ุงููููุน'] = df['ูููุน ุงูุจูุงุบ'].apply(classify_site)

    features = ['ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ', 'ุนุฏุฏ ุงูุจูุงุบุงุช', 'ุนุฏุฏ ุงูุณูุงู', 'ุตูุฉ ุงููููุน']
    X = df[features]

    try:
    df['ุชููุน_ูุณุชูู_ุงูุฃููููุฉ'] = model.predict(X)
   except Exception as e:
    st.error(f"๐ซ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชูุจุค: {e}")
    st.stop()


    st.markdown("### ูุชุงุฆุฌ ุงูุชููุน:")
    st.dataframe(df[['ููุน ุงูุฎุฏูุฉ', 'ูููุน ุงูุจูุงุบ', 'ุนุฏุฏ ุงูุณูุงู', 'ุนุฏุฏ ุงูุจูุงุบุงุช', 'ุชููุน_ูุณุชูู_ุงูุฃููููุฉ']])

    def convert_df_to_excel(df):
        return df.to_excel(index=False, engine='openpyxl')

    st.download_button("ุชุญููู ุงููุชุงุฆุฌ ูููู Excel", convert_df_to_excel(df), file_name="ุชููุนุงุช_ุงูุจูุงุบุงุช.xlsx")
